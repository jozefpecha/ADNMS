#!/bin/bash
#PBS -q qprod
#PBS -N model_eval
#PBS -A OPEN-23-32
#PBS -l select=1:ncpus=128
#PBS -l walltime=03:00:00
#PBS -k oe

#path to database with generated molecules
input_db="$1"

#path to ouput directory
output_dir="$2"

#path to reference PDB molecule (ligand from protein-ligand complex)
ref_mol="$3"

mkdir -p $output_dir

# extract mols from db with visited_ids_count = max(visited_ids_count)
sqlite3 $input_db < get_sdf.sql > $output_dir/out.sdf

# check if out.sdf is empty
if ! grep -q '[^[:space:]]' "$output_dir/out.sdf"; then
	echo "Pharmacophore didn't match any starting fragments."
	exit
fi

# split out.sdf according to number of features matched
python split_sdf.py -i $output_dir/out.sdf -o $output_dir

for dir in $output_dir/*/
do
	dir=${dir%*/}

	python model_evaluation.py -i $dir/*.sdf -o $dir -r $ref_mol

	python physchem_calc.py -i $dir/smiles.smi -o $dir/physchem_props.csv

	python /sa_scorer/sascorer_mp.py $dir/smiles.smi > $dir/sascores.csv

	#implenetation of docking and rmsd calculations is still missing!
	
	done	

	python model_evaluation_2.py -p $dir/physchem_props.csv -sa $dir/sascores.csv -s tmp_res.csv -d $dir/docking_results/docking_logs/ -r $dir/docking_results/rsmd/rsmd_results/ -o $dir/results.csv
done

echo "Done"
